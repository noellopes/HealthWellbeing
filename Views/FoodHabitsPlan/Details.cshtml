@model HealthWellbeing.Models.FoodHabitsPlan
@using System.Globalization

@{
    ViewData["Title"] = "Plan Details";

    var selectedDate = (DateTime)(ViewBag.SelectedDate ?? DateTime.Today);
    var planStatus = (string)(ViewBag.PlanStatus ?? "Active");
    int totalItems = ViewBag.TotalItems != null ? (int)ViewBag.TotalItems : 0;
    int consumedCount = ViewBag.ConsumedCount != null ? (int)ViewBag.ConsumedCount : 0;
    int notConsumedCount = ViewBag.NotConsumedCount != null ? (int)ViewBag.NotConsumedCount : 0;

    double consumedPercentage = ViewBag.ConsumedPercentage != null ? (double)ViewBag.ConsumedPercentage : 0.0;
    double notConsumedPercentage = ViewBag.NotConsumedPercentage != null ? (double)ViewBag.NotConsumedPercentage : 0.0;

    var progressRaw = (IEnumerable<dynamic>)(ViewBag.Progress ?? Enumerable.Empty<dynamic>());
    var progressList = progressRaw.ToList();

    var labelsJson = "[" + string.Join(",", progressList.Select(p => "\"" + (string)p.Label + "\"")) + "]";
    var dataJson = "[" + string.Join(",", progressList.Select(p => ((double)p.Percentage).ToString(CultureInfo.InvariantCulture))) + "]";

    var alergies = Model.Client?.ClientAlergies?
        .Where(ca => ca.Alergy != null)
        .Select(ca => ca.Alergy!.AlergyName)
        .Distinct()
        .OrderBy(x => x)
        .ToList() ?? new List<string>();

    var minDate = ViewBag.MinPlanDate as DateTime?;
    var maxDate = ViewBag.MaxPlanDate as DateTime?;

    var dayFoods = (IEnumerable<dynamic>)(ViewBag.DayFoods ?? Enumerable.Empty<dynamic>());

    var today = DateTime.Today;


}

<div class="container my-4">
    <div class="fh-wrapper">

        <div class="fh-header">
            <div class="d-flex flex-wrap align-items-center justify-content-between gap-2">
                <div class="d-flex align-items-center gap-2">
                    <i class="bi bi-info-circle-fill" style="color: var(--fi-cyan); font-size:1.15rem;"></i>
                    <h1 class="h5 mb-0 fi-titlebar">Plan Details</h1>
                </div>

                <div class="d-flex gap-2">
                    <a asp-action="Index" class="btn btn-secondary">
                        <i class="bi bi-arrow-left-circle me-1"></i> Back
                    </a>

                    @if (User.IsInRole("Nutricionista") || User.IsInRole("Nutritionist") || User.IsInRole("Administrador"))
                    {
                        <a asp-action="Edit" asp-route-id="@Model.FoodHabitsPlanId" class="btn btn-warning text-white">
                            <i class="bi bi-pencil-square me-1"></i> Edit
                        </a>
                        <a asp-action="Delete" asp-route-id="@Model.FoodHabitsPlanId" class="btn btn-danger">
                            <i class="bi bi-trash-fill me-1"></i> Delete
                        </a>
                    }
                </div>
            </div>

            <div class="mt-2 fh-badge">
                <i class="bi bi-calendar3" style="color: var(--fh-cyan);"></i>
                <span>@selectedDate.ToString("yyyy-MM-dd")</span>
                <span class="mx-1">•</span>
                <i class="bi bi-person-badge" style="color: var(--fh-cyan);"></i>
                <span>@(Model.Client?.Name ?? "Client")</span>
            </div>
        </div>

        <div class="fh-panel">
            <div class="row g-3">
                <div class="col-lg-5">
                    <div class="fh-card p-3 h-100">
                        <div class="fw-bold mb-2">Plan information</div>

                        <dl class="row mb-0">
                            <dt class="col-sm-4">Goal</dt>
                            <dd class="col-sm-8">@Model.Goal?.GoalName</dd>

                            <dt class="col-sm-4">Start</dt>
                            <dd class="col-sm-8">@Model.StartingDate.ToString("yyyy-MM-dd")</dd>

                            <dt class="col-sm-4">End</dt>
                            <dd class="col-sm-8">@Model.EndingDate.ToString("yyyy-MM-dd")</dd>



                            <dt class="col-sm-4">Status</dt>
                            <dd class="col-sm-8">
                                @if (planStatus == "Pending")
                                {
                                    <span class="badge bg-secondary">Pending</span>
                                }
                                else if (planStatus == "Finished")
                                {
                                    <span class="badge bg-danger">Finished</span>
                                }
                                else
                                {
                                    <span class="badge bg-success">Active</span>
                                }
                            </dd>

                        </dl>
                        <hr />

                        <div class="col-md-6">
                            <div class="d-flex text-center flex-column gap-2">
                                <div class="fh-badge">
                                    <i class="bi bi-check2-circle" style="color: var(--fh-cyan);"></i>
                                    <span>@consumedCount / @totalItems items completed</span>
                                </div>
                                <div class="small" style="color: var(--fh-muted);">
                                    @consumedPercentage% completed • @notConsumedPercentage% remaining
                                </div>
                            </div>
                        </div>

                        <hr />

                        <div class="fw-bold mb-2">Client allergies</div>
                        @if (!alergies.Any())
                        {
                            <div class="small" style="color: var(--fh-muted);">This client has no allergies registered.</div>
                        }
                        else
                        {
                            <div class="d-flex flex-wrap gap-2">
                                @foreach (var a in alergies)
                                {
                                    <span class="badge bg-info text-dark">@a</span>
                                }
                            </div>
                        }

                        <hr />

                        <form asp-action="Details" method="get" class="fi-toolbar">
                            <input type="hidden" name="id" value="@Model.FoodHabitsPlanId" />

                            <label class="form-label">Selected day</label>

                            <div class="d-flex gap-2 mt-2 align-items-end">
                                <input type="date"
                                       class="form-control fh-date"
                                       name="selectedDate"
                                       value="@selectedDate.ToString("yyyy-MM-dd")"
                                       min="@((minDate ?? Model.StartingDate.Date).ToString("yyyy-MM-dd"))"
                                       max="@((maxDate ?? Model.EndingDate.Date).ToString("yyyy-MM-dd"))"
                                       onchange="this.form.submit()" />

                                    <button type="submit" class="btn d-flex fi-btn-primary">
                                        <i class="bi bi-arrow-repeat "></i>Refresh
                                    </button>
                                     
                                
                            </div>

                            

                        </form>
                        
                    </div>
                </div>

                <div class="col-lg-7">
                    <div class="fh-card p-3">
                        <div class="fw-bold mb-3">
                            <i class="bi bi-pie-chart-fill me-1" style="color: var(--fi-cyan);"></i>
                            Daily completion
                        </div>

                        <div class="d-flex justify-content-center">
                            <div style="width:420px; max-width:100%;">
                                <canvas id="dailyDonutChart"></canvas>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
            <div class="fh-card mt-2 p-3">

                    <div class="row g-3">
                        <div class="fw-bold mb-2">
                            <i class="bi bi-graph-up me-1" style="color: var(--fi-cyan);"></i>
                            Progress over time
                        </div>
                        <canvas id="progressLineChart" height="260px"></canvas>
                    </div>

            </div>
            

            <div class="mt-3 fh-card p-2">
                <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 p-2">
                    <div class="fw-bold">Foods Consumed this Day</div>
                    <div class="small" style="color: var(--fh-muted);">@selectedDate.ToString("yyyy-MM-dd")</div>
                </div>

                @if (!dayFoods.Any())
                {
                    <div class="p-3 small" style="color: var(--fh-muted);">
                        No foods planned for this day.
                    </div>
                }
                else
                {
                    <div class="table-responsive">
                        <table class="table fh-table align-middle mb-0">
                            <thead>
                                <tr>
                                    <th>Food</th>
                                    <th>Category</th>
                                    <th>Portion</th>
                                    <th class="text-center">Planned</th>
                                    <th class="text-center">Eaten</th>
                                    <th class="text-center">Consumed?</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var r in dayFoods.OrderBy(x => (string)x.FoodName))
                                {
                                    bool consumed = (bool)r.Consumed;

                                    <tr>
                                        <td class="fw-semibold">@r.FoodName</td>
                                        <td>@r.CategoryName</td>
                                        <td>@r.PortionName</td>
                                        <td class="text-center">@r.PortionsPlanned</td>
                                        <td class="text-center">@r.PortionsEaten</td>
                                        <td class="text-center">
                                            @if (consumed)
                                            {
                                                <span class="badge bg-success">Yes</span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-danger">No</span>
                                            }
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
            </div>

        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const donutCtx = document.getElementById('dailyDonutChart').getContext('2d');
        const consumed = @consumedCount;
        const notConsumed = @notConsumedCount;

        new Chart(donutCtx, {
          type: 'doughnut',
          data: {
            labels: ['Completed', 'Remaining'],
            datasets: [{
              data: [consumed, notConsumed],
              backgroundColor: ['#22d3ee', '#dc2626'],
              borderWidth: 1
            }]
          },
          options: { cutout: '65%', plugins: { legend: { position: 'bottom' } } }
        });


        const lineCtx = document.getElementById('progressLineChart').getContext('2d');
        const progressLabels = @Html.Raw(labelsJson);
        const progressData = @Html.Raw(dataJson);

        new Chart(lineCtx, {
            type: 'line',
            data: {
                labels: progressLabels,
                datasets: [{
                    label: '% completed',
                    data: progressData,
                    tension: 0.3,
                    fill: true,
                    borderWidth: 2,
                    pointRadius: 3
                }]
            },
            options: {
                scales: { y: { beginAtZero: true, max: 100, ticks:{stepSize: 25} } },
                plugins: { legend: { position: 'bottom' } }
            }
        });
    </script>
}
