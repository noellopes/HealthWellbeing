@model HealthWellbeing.Models.Level
@using System.Linq;
@using System;

@{
    ViewData["Title"] = "Edit";
    var cats = ViewBag.CategoriesList as IEnumerable<string> ?? Enumerable.Empty<string>();

    var categoryValue = "";
    if (ViewData.ModelState.TryGetValue("LevelCategory", out var cms) && cms?.AttemptedValue != null)
    {
        categoryValue = cms.AttemptedValue;
    }
    else if (!string.IsNullOrWhiteSpace(Model?.LevelCategory))
    {
        categoryValue = Model.LevelCategory;
    }

    var categoryInList = cats.Any(c => string.Equals(c, categoryValue, StringComparison.OrdinalIgnoreCase));
    var showNewBox = !categoryInList && categoryValue != "__new";
    if (ViewData.ModelState.ContainsKey("LevelCategory") && categoryValue == "__new")
    {
        showNewBox = true;
    }

    if (string.IsNullOrWhiteSpace(categoryValue) && ViewData.ModelState["LevelCategory"]?.Errors.Any() == true && !cats.Any())
    {
        showNewBox = true;
    }
    else if (categoryInList)
    {
        showNewBox = false;
    }
}

<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-lg-6 col-md-8">
            <div class="card shadow-sm">

                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">Edit Level</h5>
                </div>

                <div class="card-body">

                    <div asp-validation-summary="ModelOnly" class="alert alert-danger" role="alert" id="validationSummary"></div>

                    <form asp-action="Edit" method="post" id="editLevelForm" novalidate>
                        @Html.AntiForgeryToken()
                        <input type="hidden" asp-for="LevelId" />

                        <input type="hidden" name="page" value="@ViewBag.Page" />
                        <input type="hidden" name="searchNumber" value="@ViewBag.SearchNumber" />
                        <input type="hidden" name="searchCategory" value="@ViewBag.SearchCategory" />
                        <input type="hidden" name="searchDescription" value="@ViewBag.SearchDescription" />

                        <div class="form-floating mb-3">
                            <input asp-for="LevelNumber"
                                   type="number"
                                   min="1" max="100"
                                   class="form-control @(ViewData.ModelState["LevelNumber"]?.Errors.Any() == true ? "is-invalid" : "")"
                                   placeholder="Level number" />
                            <label asp-for="LevelNumber"></label>
                            <span asp-validation-for="LevelNumber" class="invalid-feedback"></span>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Category</label>

                            <div class="d-flex gap-2">

                                <select asp-for="LevelCategory" id="categorySelect" class="form-select bg-white @(ViewData.ModelState["LevelCategory"]?.Errors.Count > 0 ? "is-invalid" : "")" aria-label="Category selector">
                                    @foreach (var c in cats)
                                    {
                                        <option value="@c">@c</option>
                                    }

                                    @if (showNewBox)
                                    {
                                        <option value="__new" selected>-- New category --</option>
                                    }
                                    else
                                    {
                                        <option value="__new">-- New category --</option>
                                    }
                                </select>

                                <input id="categoryNew"
                                       name="categoryNew"
                                       type="text"
                                       class="form-control @(ViewData.ModelState["LevelCategory"]?.Errors.Any() == true && showNewBox ? "is-invalid" : "")"
                                       value="@(showNewBox? categoryValue : "")"
                                       placeholder="Type new category"
                                       style="min-width:220px; @(showNewBox ? "" : "display:none;")" />
                            </div>

                            <span asp-validation-for="LevelCategory" class="invalid-feedback"></span>
                        </div>

                        <!-- NOVO CAMPO: Points Limit -->
                        <div class="form-floating mb-3">
                            <input asp-for="LevelPointsLimit"
                                   type="number"
                                   min="0"
                                   class="form-control @(ViewData.ModelState["LevelPointsLimit"]?.Errors.Count > 0 ? "is-invalid" : "")"
                                   placeholder="Points Limit" />
                            <label asp-for="LevelPointsLimit">Points Limit</label>
                            <span asp-validation-for="LevelPointsLimit" class="invalid-feedback"></span>
                        </div>
                        <!-- FIM -->

                        <div class="form-floating mb-3">
                            <textarea asp-for="Description"
                                      class="form-control @(ViewData.ModelState["Description"]?.Errors.Any() == true ? "is-invalid" : "")"
                                      style="height:120px"
                                      placeholder="Description"></textarea>
                            <label asp-for="Description"></label>
                            <span asp-validation-for="Description" class="invalid-feedback"></span>
                        </div>

                        <div class="d-flex justify-content-between">
                            <a asp-action="Index"
                               asp-route-page="@ViewBag.Page"
                               asp-route-searchNumber="@ViewBag.SearchNumber"
                               asp-route-searchCategory="@ViewBag.SearchCategory"
                               asp-route-searchDescription="@ViewBag.SearchDescription"
                               class="btn btn-outline-secondary">Cancel</a>

                            <button type="submit" class="btn btn-primary">Save</button>
                        </div>

                    </form>

                </div>

            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    @* JavaScript mantido igual *@
    <style>
        .invalid-feedback {
            display: block;
        }

        #validationSummary ul {
            margin: 0;
            padding-left: 1.25rem;
        }

        .form-control.is-invalid, .form-select.is-invalid {
            box-shadow: 0 0 0 0.15rem rgba(220,53,69,.08);
            border-color: #dc3545;
        }
    </style>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            var select = document.getElementById('categorySelect');
            var newInput = document.getElementById('categoryNew');
            var form = document.getElementById('editLevelForm');

            function setNewVisibility(show) {
                newInput.style.display = show ? '' : 'none';
                if (show) newInput.focus();
            }
            function ensureOptionAndSelect(value) {
                if (select.value === "__new") { return; }
            }
            setNewVisibility(select.value === "__new");
            select.addEventListener('change', function () {
                setNewVisibility(this.value === "__new");
                toggleValidationForElement(select);
            });
            if (newInput) {
                newInput.addEventListener('keydown', function (e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        var v = this.value.trim();
                        if (v.length > 0) ensureOptionAndSelect(v);
                        this.blur();
                    }
                });
                newInput.addEventListener('blur', function () {
                    var v = this.value.trim();
                    if (v.length > 0) ensureOptionAndSelect(v);
                });
                newInput.addEventListener('input', function () {
                    toggleValidationForElement(newInput);
                });
            }
            form.addEventListener('submit', function (e) {
                if (select.value === "__new") {
                    const typed = newInput.value.trim();
                    if (typed.length > 0) {
                        const option = document.createElement('option');
                        option.value = typed;
                        option.textContent = typed;
                        select.appendChild(option);
                        select.value = typed;
                    } else {
                        select.value = "";
                    }
                }
            });
            function toggleValidationForElement(el) {
                if (!el) return;
                var name = el.name || el.getAttribute('asp-for') || el.id;
                if (el.id === 'categoryNew') { name = 'LevelCategory'; }
                var message = document.querySelector('[data-valmsg-for="' + (name || '') + '"]');
                if (message && message.innerText.trim().length > 0) {
                    el.classList.add('is-invalid');
                } else {
                    el.classList.remove('is-invalid');
                }
            }
            if (typeof jQuery !== 'undefined' && typeof jQuery.validator !== 'undefined' && typeof jQuery.validator.unobtrusive !== 'undefined') {
                var $form = $('#editLevelForm');
                if (!$form.data('validator')) { $.validator.unobtrusive.parse($form); }
                $form.on('invalid-form.validate', function (e, validator) {
                    var summary = $('#validationSummary');
                    if (validator.numberOfInvalids()) {
                        var list = $('<ul/>');
                        $.each(validator.errorList, function () { list.append($('<li/>').text(this.message)); });
                        summary.html(list).removeClass('d-none').addClass('alert-danger');
                    } else {
                        summary.addClass('d-none').removeClass('alert-danger').empty();
                    }
                    $form.find('.is-invalid').removeClass('is-invalid');
                    $.each(validator.errorList, function () { $(this.element).addClass('is-invalid'); });
                    if (validator.errorMap.LevelCategory && select.value === "__new") { $(newInput).addClass('is-invalid'); }
                });
                $form.on('keyup change', 'input, select, textarea', function () {
                    var $el = $(this);
                    var name = $el.attr('name');
                    if ($el.attr('id') === 'categoryNew') { name = 'LevelCategory'; }
                    var message = $('[data-valmsg-for="' + name + '"]');
                    if (message && message.text().trim().length === 0) { $el.removeClass('is-invalid'); }
                });
            } else {
                if (newInput) {
                    newInput.addEventListener('input', function () { toggleValidationForElement(newInput); });
                }
            }
            Array.from(document.querySelectorAll('[data-valmsg-for]')).forEach(function (msg) {
                var elName = msg.getAttribute('data-valmsg-for');
                var field = document.querySelector('[name="' + elName + '"]') || document.getElementById(elName);
                if (msg.innerText.trim().length > 0 && field) {
                    field.classList.add('is-invalid');
                    if (elName === 'LevelCategory' && select.value === '__new') { newInput.classList.add('is-invalid'); }
                }
            });
            if (form.querySelector('.is-invalid')) {
                var errors = form.querySelectorAll('.invalid-feedback');
                var list = document.createElement('ul');
                let hasErrors = false;
                errors.forEach(function(error) {
                    if (error.innerText.trim().length > 0) {
                        var listItem = document.createElement('li');
                        listItem.innerText = error.innerText.trim();
                        list.appendChild(listItem);
                        hasErrors = true;
                    }
                });
                var summary = document.getElementById('validationSummary');
                if (hasErrors) { summary.appendChild(list); summary.classList.remove('d-none'); }
            }
        });
    </script>
}