@model HealthWellbeing.Models.Plan
@using System.Globalization

@{
    ViewData["Title"] = "Plan Details";

    var selectedDate = (DateTime)(ViewBag.SelectedDate ?? DateTime.Today);
    int totalItems = ViewBag.TotalItems != null ? (int)ViewBag.TotalItems : 0;
    int consumedCount = ViewBag.ConsumedCount != null ? (int)ViewBag.ConsumedCount : 0;
    int notConsumedCount = ViewBag.NotConsumedCount != null ? (int)ViewBag.NotConsumedCount : 0;
    double consumedPercentage = ViewBag.ConsumedPercentage != null ? (double)ViewBag.ConsumedPercentage : 0.0;
    double notConsumedPercentage = ViewBag.NotConsumedPercentage != null ? (double)ViewBag.NotConsumedPercentage : 0.0;

    var progressRaw = (IEnumerable<dynamic>)(ViewBag.Progress ?? Enumerable.Empty<dynamic>());
    var progressList = progressRaw.ToList();

    var labelsJson = "[" + string.Join(",", progressList.Select(p => "\"" + (string)p.Label + "\"")) + "]";
    var dataJson = "[" + string.Join(",", progressList.Select(p =>
        ((double)p.Percentage).ToString(CultureInfo.InvariantCulture))) + "]";

}

<div class="d-flex justify-content-between align-items-center mb-3">
    <div class="d-flex align-items-center">
        <h1 class="h4 mb-0">
            <i class="bi bi-info-circle-fill me-2 text-info"></i>
            Plan Details
        </h1>
    </div>

    <a asp-action="Index" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left-circle me-1"></i> Back to list
    </a>
</div>

<hr />
@{
    var client = ViewBag.Client as HealthWellbeing.Models.Client;
    var nutritionist = ViewBag.Nutritionist as HealthWellbeing.Models.Nutritionist;
    var goals = ViewBag.ClientGoals as List<HealthWellbeing.Models.Goal> ?? new();
}

<div class="row">
    <div class="col-md-5">
        <h5 class="mb-3">Plan information</h5>
        <dl class="row">
            <dt class="col-sm-4">Starting Date</dt>
            <dd class="col-sm-8">@Model.StartingDate.ToShortDateString()</dd>

            <dt class="col-sm-4">Ending Date</dt>
            <dd class="col-sm-8">@Model.EndingDate.ToShortDateString()</dd>

            <dt class="col-sm-4">Status</dt>
            <dd class="col-sm-8">
                @if (Model.Done)
                {
                    <span class="badge bg-success">
                        <i class="bi bi-check-circle-fill me-1"></i> Done
                    </span>
                }
                else
                {
                    <span class="badge bg-secondary">
                        <i class="bi bi-hourglass-split me-1"></i> In progress
                    </span>
                }
            </dd>
        </dl>

        <hr />

        <h5 class="mb-3">Client &amp; Nutritionist</h5>
        <dl class="row">
            <dt class="col-sm-4">Client</dt>
            <dd class="col-sm-8">
                @if (client != null)
                {
                    @client.Name <br />
                    <small class="text-muted">@client.Email</small>
                }
                else
                {
                    <span class="text-muted">No client associated</span>
                }
            </dd>

            <dt class="col-sm-4">Nutritionist</dt>
            <dd class="col-sm-8">
                @if (nutritionist != null)
                {
                    @nutritionist.Name <br />
                    <small class="text-muted">@nutritionist.Email</small>
                }
                else
                {
                    <span class="text-muted">No nutritionist associated</span>
                }
            </dd>
        </dl>

        <hr />

        <h5 class="mb-3">Client goals</h5>
        @if (goals.Any())
        {
            <div class="table-responsive">
                <table class="table table-sm table-bordered align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>Goal</th>
                            <th>Calories</th>
                            <th>Protein</th>
                            <th>Fat</th>
                        </tr>
                    </thead>
                    <tbody>
                    @foreach (var g in goals)
                    {
                        <tr>
                            <td>@g.GoalName</td>
                            <td>@g.DailyCalories</td>
                            <td>@g.DailyProtein</td>
                            <td>@g.DailyFat</td>
                        </tr>
                    }
                    </tbody>
                </table>
            </div>
        }
        else
        {
            <p class="text-muted">This client has no goals registered.</p>
        }

        <div class="col-md-4">
                <label class="form-label fw-semibold">Select day</label>
                <input type="date"
                       class="form-control"
                       name="selectedDate"
                       value="@selectedDate.ToString("yyyy-MM-dd")" />
            </div>

    </div>

    <div class="col-md-5">
        <div class="card border-0 shadow-sm h-60">
            <div class="card-body">
                <h5 class="card-title mb-4">
                    <i class="bi bi-pie-chart-fill text-success me-1"></i>
                    Daily Intake
                </h5>
                <canvas id="dailyDonutChart" height="200" ></canvas>

                <div class="mt-1">
                    <span class="badge bg-success me-1">
                        @consumedPercentage% consumed
                    </span>
                    <span class="badge bg-danger">
                        @notConsumedPercentage% not consumed
                    </span>
                </div>
            </div>
        </div>
    </div>
<hr />

<h5 class="mb-3">Foods in this plan</h5>

@if (Model.FoodPlans != null && Model.FoodPlans.Any())
{
    <div class="table-responsive">
        <table class="table table-sm table-striped table-bordered align-middle">
            <thead class="table-light">
                <tr>
                    <th>Food</th>
                    <th>Portion</th>
                    <th>Food Intake</th>
                </tr>
            </thead>
            <tbody>
            @foreach (var fp in Model.FoodPlans)
            {
                <tr>
                    <td>@fp.Food?.Name</td>
                    <td>@fp.Portion?.PortionName</td>
                    
                </tr>
            }
            </tbody>
        </table>
    </div>
}
else
{
    <p class="text-muted">No foods associated with this plan.</p>
}

<div class="mt-3 d-flex gap-2">
    <a asp-action="Edit" asp-route-id="@Model.PlanId"
       class="btn btn-warning text-white">
        <i class="bi bi-pencil-square me-1"></i> Edit
    </a>
    <a asp-action="Index" class="btn btn-secondary">
        <i class="bi bi-arrow-left-circle me-1"></i> Back to list
    </a>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // ---------- Donut ----------
        const donutCtx = document.getElementById('dailyDonutChart').getContext('2d');

        const consumed = @consumedCount;
        const notConsumed = @notConsumedCount;

        new Chart(donutCtx, {
            type: 'doughnut',
            data: {
                labels: ['Consumed', 'Not consumed'],
                datasets: [{
                    data: [consumed, notConsumed],
                    backgroundColor: ['#28a745', '#dc3545'],
                    borderWidth: 1
                }]
            },
            options: {
                cutout: '65%',
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });

        // ---------- Line chart ----------
        const lineCtx = document.getElementById('progressLineChart').getContext('2d');

        const progressLabels = @Html.Raw(labelsJson);
        const progressData = @Html.Raw(dataJson);

        new Chart(lineCtx, {
            type: 'line',
            data: {
                labels: progressLabels,
                datasets: [{
                    label: '% consumed',
                    data: progressData,
                    tension: 0.3,
                    fill: false,
                    borderWidth: 2,
                    pointRadius: 4
                }]
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'bottom'
                    }
                }
            }
        });
    </script>
}

