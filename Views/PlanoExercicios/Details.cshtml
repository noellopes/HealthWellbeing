@model HealthWellbeing.Models.PlanoExercicios

@{
    ViewData["Title"] = "O Meu Treino";
    bool mostrarAviso = ViewBag.MostrarAvisoReinicio == true;
}

@* --- 1. BLOCO DE AVISO (Reiniciar) --- *@
@if (mostrarAviso)
{
    <div class="alert alert-danger shadow-sm mb-4" role="alert">
        <h4 class="alert-heading"><i class="bi bi-exclamation-triangle-fill"></i> Tem a certeza?</h4>
        <p>Ao reiniciar o plano, <strong>todo o seu progresso (checkboxes) e as cargas registadas serão apagados</strong>. Esta ação não pode ser desfeita.</p>
        <hr>
        <div class="d-flex justify-content-end gap-2">
            <a asp-action="Details" asp-route-id="@Model.PlanoExerciciosId" class="btn btn-secondary">Cancelar</a>
            <form asp-action="ReiniciarPlano" asp-route-id="@Model.PlanoExerciciosId" method="post">
                <button type="submit" class="btn btn-danger">Confirmar Reinício</button>
            </form>
        </div>
    </div>
}

@* --- 2. CABEÇALHO E BOTÕES --- *@
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="text-primary"><i class="bi bi-activity"></i> Plano de Treino</h1>
    <div class="d-flex gap-2">
        <button type="submit" form="mainForm" class="btn btn-success shadow-sm">
            <i class="bi bi-save"></i> Guardar Tudo
        </button>

        <a asp-action="Details"
           asp-route-id="@Model.PlanoExerciciosId"
           asp-route-mostrarAviso="true"
           class="btn btn-warning text-dark shadow-sm">
            <i class="bi bi-arrow-counterclockwise"></i> Reiniciar
        </a>

        <a asp-action="Index" class="btn btn-secondary shadow-sm">
            <i class="bi bi-arrow-left"></i> Voltar
        </a>
    </div>
</div>

@* --- 3. BARRA DE PROGRESSO --- *@
<div class="card shadow-sm mb-4 border-0">
    <div class="card-body bg-light rounded">
        <h5 class="card-title fw-bold text-secondary">
            <i class="bi bi-person-circle me-2"></i>Utente: <span class="text-dark">@Model.UtenteGrupo7?.Nome</span>
        </h5>

        @{
            var total = Model.PlanoExercicioExercicios?.Count ?? 0;
            var concluidos = Model.PlanoExercicioExercicios?.Count(x => x.Concluido) ?? 0;
            var percentagem = total > 0 ? (concluidos * 100) / total : 0;
            string barColor = percentagem == 100 ? "bg-success" : "bg-primary";
        }

        <div class="progress mt-3" style="height: 25px; font-size: 1rem;">
            <div class="progress-bar @barColor progress-bar-striped progress-bar-animated"
                 role="progressbar"
                 style="width: @percentagem%;"
                 aria-valuenow="@percentagem"
                 aria-valuemin="0"
                 aria-valuemax="100">
                @percentagem% Concluído
            </div>
        </div>
    </div>
</div>

@* --- 4. LISTA DE EXERCÍCIOS (FORMULÁRIO) --- *@
@if (Model.PlanoExercicioExercicios != null && Model.PlanoExercicioExercicios.Any())
{
    <form id="mainForm" asp-action="SalvarProgressoGlobal" method="post">
        <div class="table-responsive card shadow-sm border-0">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-dark">
                    <tr>
                        <th style="width: 25%;">Exercício</th>
                        <th style="width: 15%;">Séries x Reps</th>
                        <th style="width: 20%;">Equipamento</th>
                        <th style="width: 15%;">Carga (Kg)</th>
                        <th class="text-center" style="width: 10%;">Estado</th>
                        <th class="text-center" style="width: 10%;">Detalhes</th>
                    </tr>
                </thead>
                <tbody>
                    @for (int i = 0; i < Model.PlanoExercicioExercicios.Count; i++)
                    {
                        var item = Model.PlanoExercicioExercicios.ElementAt(i);

                        // LÓGICA: Verifica se algum equipamento requer peso
                        bool precisaPeso = item.Exercicio.ExercicioEquipamentos != null &&
                        item.Exercicio.ExercicioEquipamentos.Any(eq => eq.Equipamento.RequerPeso);

                        string rowClass = item.Concluido ? "table-success" : "";

                        <tr class="@rowClass">
                            @* Inputs Ocultos Essenciais *@
                            <input type="hidden" name="[@i].PlanoExerciciosId" value="@item.PlanoExerciciosId" />
                            <input type="hidden" name="[@i].ExercicioId" value="@item.ExercicioId" />

                            @* Coluna Exercício *@
                            <td>
                                <div class="fw-bold">@item.Exercicio.ExercicioNome</div>
                                <div class="small text-muted text-truncate" style="max-width: 250px;">
                                    @item.Exercicio.Descricao
                                </div>
                            </td>

                            @* Coluna Séries *@
                            <td>
                                <span class="badge bg-light text-dark border">
                                    @item.Exercicio.Series <i class="bi bi-x"></i> @item.Exercicio.Repeticoes
                                </span>
                            </td>

                            @* Coluna Equipamento *@
                            <td>
                                @if (item.Exercicio.ExercicioEquipamentos != null)
                                {
                                    foreach (var eq in item.Exercicio.ExercicioEquipamentos)
                                    {
                                        if (eq.Equipamento.RequerPeso)
                                        {
                                            <span class="badge bg-warning text-dark me-1 border border-dark" title="Requer Carga">
                                                <i class="bi bi-box-seam-fill"></i> @eq.Equipamento.NomeEquipamento
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-secondary me-1">@eq.Equipamento.NomeEquipamento</span>
                                        }
                                    }
                                }
                            </td>

                            @* Coluna Carga *@
                            <td>
                                @if (precisaPeso)
                                {
                                    <div class="input-group input-group-sm">
                                        <input type="number"
                                               step="0.5"
                                               min="0"
                                               name="[@i].PesoUsado"
                                               value="@(item.PesoUsado?.ToString("F1").Replace(",", "."))"
                                               class="form-control fw-bold text-primary"
                                               placeholder="Obrigatório"
                                               required
                                               title="Introduza a carga utilizada" />
                                        <span class="input-group-text">kg</span>
                                    </div>
                                }
                                else
                                {
                                    <span class="text-muted small fst-italic">N/A</span>
                                    @* Input hidden a null para manter o index do array correto *@
                                    <input type="hidden" name="[@i].PesoUsado" value="" />
                                }
                            </td>

                            @* Coluna Checkbox (Estado) *@
                            <td class="text-center">
                                <div class="form-check d-flex justify-content-center">
                                    <input class="form-check-input border-2 border-primary"
                                           type="checkbox"
                                           name="[@i].Concluido"
                                           value="true"
                                           style="transform: scale(1.4); cursor: pointer;"
                                           @(item.Concluido ? "checked" : "") />

                                    @* Fallback para false se desmarcado *@
                                    <input type="hidden" name="[@i].Concluido" value="false" />
                                </div>
                            </td>

                            @* Coluna Detalhes *@
                            <td class="text-center">
                                <a href="@Url.Action("Details", "Exercicios", new { id = item.ExercicioId })"
                                   target="_blank"
                                   class="btn btn-sm btn-outline-info"
                                   title="Ver Detalhes do Exercício">
                                    <i class="bi bi-eye-fill"></i>
                                </a>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </form>
}
else
{
    <div class="alert alert-info shadow-sm d-flex align-items-center">
        <i class="bi bi-info-circle-fill me-3 fs-4"></i>
        <div>
            <strong>Atenção:</strong> Este plano ainda não tem exercícios associados.
        </div>
    </div>
}