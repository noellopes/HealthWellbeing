@model HealthWellbeing.Models.PlanoExercicios

@{
    ViewData["Title"] = "O Meu Treino";
    bool mostrarAviso = ViewBag.MostrarAvisoReinicio == true;
}

@if (mostrarAviso)
{
    <div class="alert alert-danger shadow-sm mb-4" role="alert">
        <h4 class="alert-heading"><i class="bi bi-exclamation-triangle-fill"></i> Tem a certeza?</h4>
        <p>Ao reiniciar o plano, <strong>todo o seu progresso (checkboxes) e as cargas registadas serão apagados</strong>. Esta ação não pode ser desfeita.</p>
        <hr>
        <div class="d-flex justify-content-end gap-2">
            <a asp-action="Details" asp-route-id="@Model.PlanoExerciciosId" class="btn btn-secondary">Cancelar</a>

            <form asp-action="ReiniciarPlano" asp-route-id="@Model.PlanoExerciciosId" method="post">
                <button type="submit" class="btn btn-danger">Confirmar Reinício</button>
            </form>
        </div>
    </div>
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Plano de Treino</h1>
    <div class="d-flex gap-2">

        <button type="submit" form="mainForm" class="btn btn-primary shadow-sm">
            <i class="bi bi-save"></i> Guardar Tudo
        </button>

        <a asp-action="Details"
           asp-route-id="@Model.PlanoExerciciosId"
           asp-route-mostrarAviso="true"
           class="btn btn-warning text-dark shadow-sm">
            <i class="bi bi-arrow-counterclockwise"></i> Reiniciar
        </a>

        <a asp-action="Index" class="btn btn-secondary shadow-sm">Voltar</a>
    </div>
</div>

<div class="card shadow-sm mb-4">
    <div class="card-body">
        <h5 class="card-title">Utente: @Model.UtenteGrupo7?.Nome</h5>
        <div class="progress mt-2" style="height: 25px;">
            @{
                var total = Model.PlanoExercicioExercicios?.Count ?? 0;
                var concluidos = Model.PlanoExercicioExercicios?.Count(x => x.Concluido) ?? 0;
                var percentagem = total > 0 ? (concluidos * 100) / total : 0;
            }
            <div class="progress-bar bg-success progress-bar-striped progress-bar-animated" role="progressbar" style="width: @percentagem%;" aria-valuenow="@percentagem" aria-valuemin="0" aria-valuemax="100">
                @percentagem% Concluído
            </div>
        </div>
    </div>
</div>

@if (Model.PlanoExercicioExercicios != null && Model.PlanoExercicioExercicios.Any())
{
    <form id="mainForm" asp-action="SalvarProgressoGlobal" method="post">

        <div class="table-responsive card shadow-sm">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-dark">
                    <tr>
                        <th>Exercício</th>
                        <th>Séries x Reps</th>
                        <th>Equipamento</th>
                        <th style="width: 150px;">Carga (Kg)</th>
                        <th class="text-center">Estado</th>
                        <th class="text-center">Detalhes</th>
                    </tr>
                </thead>
                <tbody>
                    @for (int i = 0; i < Model.PlanoExercicioExercicios.Count; i++)
                    {
                        var item = Model.PlanoExercicioExercicios.ElementAt(i);

                        bool usaPesos = item.Exercicio.ExercicioEquipamentos != null &&
                        item.Exercicio.ExercicioEquipamentos.Any(eq =>
                        (eq.Equipamento.NomeEquipamento ?? "").Contains("Peso") ||
                        (eq.Equipamento.NomeEquipamento ?? "").Contains("Halter") ||
                        (eq.Equipamento.NomeEquipamento ?? "").Contains("Barra") ||
                        (eq.Equipamento.NomeEquipamento ?? "").Contains("Máquina"));

                        string rowClass = item.Concluido ? "table-success" : "";

                        <tr class="@rowClass">
                            <input type="hidden" name="[@i].PlanoExerciciosId" value="@item.PlanoExerciciosId" />
                            <input type="hidden" name="[@i].ExercicioId" value="@item.ExercicioId" />

                            <td>
                                <strong>@item.Exercicio.ExercicioNome</strong><br />
                                <small class="text-muted">@item.Exercicio.Descricao</small>
                            </td>
                            <td>@item.Exercicio.Series x @item.Exercicio.Repeticoes</td>
                            <td>
                                @if (item.Exercicio.ExercicioEquipamentos != null)
                                {
                                    foreach (var eq in item.Exercicio.ExercicioEquipamentos)
                                    {
                                        <span class="badge bg-secondary me-1">@eq.Equipamento.NomeEquipamento</span>
                                    }
                                }
                            </td>

                            <td>
                                @if (usaPesos)
                                {
                                    <div class="input-group input-group-sm">
                                        <input type="number" step="0.5" min="0"
                                               name="[@i].PesoUsado"
                                               value="@(item.PesoUsado?.ToString("F1").Replace(",", "."))"
                                               class="form-control" placeholder="0.0" />
                                        <span class="input-group-text">kg</span>
                                    </div>
                                }
                                else
                                {
                                    <span class="text-muted small">N/A</span>
                                    <input type="hidden" name="[@i].PesoUsado" value="" />
                                }
                            </td>

                            <td class="text-center">
                                <div class="form-check d-flex justify-content-center">
                                    <input class="form-check-input" type="checkbox"
                                           name="[@i].Concluido"
                                           value="true"
                                           style="transform: scale(1.5); cursor: pointer;"
                                           @(item.Concluido ? "checked" : "") />
                                    <input type="hidden" name="[@i].Concluido" value="false" />
                                </div>
                                <small class="d-block mt-1">@(item.Concluido ? "Feito" : "Pendente")</small>
                            </td>

                            <td class="text-center">
                                <a href="@Url.Action("Details", "Exercicio", new { id = item.ExercicioId })"
                                   target="_blank"
                                   class="btn btn-sm btn-info text-white"
                                   title="Ver Detalhes">
                                    <i class="bi bi-eye"></i> Detalhes
                                </a>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </form>
}
else
{
    <div class="alert alert-info shadow-sm">
        <i class="bi bi-info-circle"></i> Este plano ainda não tem exercícios associados.
    </div>
}