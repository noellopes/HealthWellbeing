@model HealthWellBeing.Models.Exame

@{
    ViewData["Title"] = "Nova Marcação de Exame";

    var materiaisAtivos = new HashSet<string>(
        (Model.RegistoMateriais ?? new List<HealthWellbeing.ViewModels.RegistoMateriais>())
        .Select(rm => (rm.Nome ?? "") + (rm.Tamanho ?? ""))
    );

    int linhasExtras = ViewBag.LinhasAdicionais ?? 1;
}

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="h3 text-secondary">Nova Marcação de Exame</h1>
        <a asp-action="Index" class="btn btn-outline-secondary btn-sm">Voltar à Lista</a>
    </div>

    <div class="card shadow-sm border-0">
        <div class="card-header bg-success text-white py-3">
            <h5 class="card-title mb-0"><i class="bi bi-plus-circle me-2"></i> Registar Novo Exame</h5>
        </div>

        <div class="card-body p-4">
            <form asp-action="Create" method="post" id="mainForm">
                <input type="hidden" name="actionType" id="actionType" value="Save" />
                <input type="hidden" name="novoExameTipoId" id="novoExameTipoId" value="" />
                <input type="hidden" name="adicionarLinhas" id="adicionarLinhas" value="@linhasExtras" />

                <div asp-validation-summary="All" class="text-danger mb-3"></div>

                <div class="row">
                    @* --- Coluna Esquerda: Informação do Exame --- *@
                    <div class="col-md-5 border-end">
                        <h6 class="text-muted text-uppercase small mb-3 border-bottom pb-2">Informação Base</h6>

                        <div class="mb-3">
                            <label asp-for="UtenteId" class="form-label fw-bold">Utente</label>
                            <select asp-for="UtenteId" class="form-select" asp-items="ViewBag.UtenteId">
                                <option value="">-- Selecione o Utente --</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label asp-for="DataHoraMarcacao" class="form-label fw-bold">Data e Hora</label>
                            <input asp-for="DataHoraMarcacao" type="datetime-local" class="form-control" />
                        </div>

                        <div class="mb-3">
                            <label asp-for="Estado" class="form-label fw-bold">Estado do Exame</label>
                            <select asp-for="Estado" class="form-select">
                                @foreach (var op in HealthWellBeing.Models.Exame.OpcoesEstado)
                                {
                                    <option value="@op">@op</option>
                                }
                            </select>
                        </div>

                        <div class="mb-4 bg-light p-3 border rounded shadow-sm">
                            <label asp-for="ExameTipoId" class="form-label fw-bold text-primary">Tipo de Exame</label>
                            <select asp-for="ExameTipoId" class="form-select border-primary"
                                    asp-items="ViewBag.ExameTipoId"
                                    onchange="document.getElementById('actionType').value='Refresh'; document.getElementById('novoExameTipoId').value=this.value; this.form.submit();">
                                <option value="">-- selecione para carregar receita --</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label asp-for="MedicoSolicitanteId" class="form-label fw-bold small">Médico Solicitante</label>
                            <select asp-for="MedicoSolicitanteId" class="form-select" asp-items="ViewBag.MedicoSolicitanteId"></select>
                        </div>

                        <div class="mb-3">
                            <label asp-for="ProfissionalExecutanteId" class="form-label fw-bold small">Executante</label>
                            <select asp-for="ProfissionalExecutanteId" class="form-select" asp-items="ViewBag.ProfissionalExecutanteId"></select>
                        </div>

                        <div class="mb-3">
                            <label asp-for="SalaDeExameId" class="form-label fw-bold">Sala</label>
                            <select asp-for="SalaDeExameId" class="form-select" asp-items="ViewBag.SalaDeExameId"></select>
                        </div>

                        <div class="mb-3">
                            <label asp-for="Notas" class="form-label fw-bold">Notas</label>
                            <textarea asp-for="Notas" class="form-control" rows="3" placeholder="Observações..."></textarea>
                        </div>
                    </div>

                    @* --- Coluna Direita: Materiais --- *@
                    <div class="col-md-7">
                        <h6 class="text-muted text-uppercase small mb-3 border-bottom pb-2">Materiais do Catálogo</h6>

                        <div class="border rounded bg-white" style="max-height:480px; overflow-y:auto;">
                            <table class="table table-sm table-hover align-middle mb-0">
                                <thead class="table-dark">
                                    <tr>
                                        <th style="width:40px;"></th>
                                        <th>Material</th>
                                        <th style="width:80px;">Qtd</th>
                                        <th>Estado do Material</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var item in (List<HealthWellbeing.Models.MaterialEquipamentoAssociado>)ViewBag.DicionarioCompleto)
                                    {
                                        var chaveItem = (item.NomeEquipamento ?? "") + (item.Tamanho ?? "");
                                        var regReceita = Model.RegistoMateriais?.FirstOrDefault(r => r.Nome == item.NomeEquipamento && r.Tamanho == item.Tamanho);
                                        bool isChecked = materiaisAtivos.Contains(chaveItem);

                                        <tr>
                                            <td class="text-center">
                                                <input type="checkbox" name="selecionadosIds" value="@item.MaterialEquipamentoAssociadoId" @(isChecked ? "checked" : "") />
                                            </td>
                                            <td>
                                                <strong>@item.NomeEquipamento</strong><br />
                                                <small class="text-muted">@(item.Tamanho ?? "N/A")</small>
                                            </td>
                                            <td>
                                                <input type="number" name="quantidades" class="form-control form-control-sm"
                                                       value="@(isChecked ? regReceita.Quantidade : 1)" min="1" />
                                            </td>
                                            <td>
                                                <select name="estadosIds" class="form-select form-select-sm">
                                                    @foreach (var est in (ViewBag.ListaEstadosMateriais as SelectList))
                                                    {
                                                        @* Lógica Corrigida: 
                                                           1. Se o item está na receita, mantém o que vem da receita.
                                                           2. Se é um novo item (não checked), o padrão é "1" (Reservado).
                                                        *@
                                                        bool isSelected = (isChecked && regReceita.MaterialStatusId.ToString() == est.Value)
                                                                       || (!isChecked && est.Value == "1");

                                                        <option value="@est.Value" selected="@(isSelected ? "selected" : null)">@est.Text</option>
                                                    }
                                                </select>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>

                        @* --- Novos Materiais (Opção B) --- *@
                        <div class="mt-4 p-3 border rounded bg-light shadow-sm">
                            <h6 class="fw-bold text-success mb-3"><i class="bi bi-plus-square-fill me-1"></i> Adição Manual de Materiais</h6>

                            @for (int i = 0; i < linhasExtras; i++)
                            {
                                <div class="row g-2 mb-2">
                                    <input type="hidden" name="selecionadosIds" value="0" />
                                    <div class="col-5">
                                        <input type="text" name="nomesNovos" class="form-control form-control-sm" placeholder="Nome" />
                                    </div>
                                    <div class="col-3">
                                        <input type="text" name="tamanhosNovos" class="form-control form-control-sm" placeholder="Ex: 5ml" />
                                    </div>
                                    <div class="col-2">
                                        <input type="number" name="quantidades" value="1" class="form-control form-control-sm" />
                                    </div>
                                    <div class="col-2">
                                        <select name="estadosIds" class="form-select form-select-sm">
                                            @foreach (var est in (ViewBag.ListaEstadosMateriais as SelectList))
                                            {
                                                @* Novos itens manuais sempre iniciam como "1" (Reservado) *@
                                                <option value="@est.Value" selected="@(est.Value == "1" ? "selected" : null)">@est.Text</option>
                                            }
                                        </select>
                                    </div>
                                </div>
                            }

                            <div class="text-center mt-3">
                                <button type="submit" name="actionType" value="Refresh"
                                        onclick="document.getElementById('adicionarLinhas').value = @(linhasExtras + 1);"
                                        class="btn btn-outline-success btn-sm">
                                    <i class="bi bi-plus-circle me-1"></i> Adicionar mais uma linha
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4 pt-3 border-top">
                    <button type="submit" name="actionType" value="Save" class="btn btn-success btn-lg px-5 shadow">
                        <i class="bi bi-check-lg me-1"></i> Finalizar Marcação
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>