@model HealthWellBeing.Models.Exame

@{
    ViewData["Title"] = "Editar Exame";

    var materiaisAtivos = new HashSet<string>(
        (Model.RegistoMateriais ?? new List<HealthWellbeing.ViewModels.RegistoMateriais>())
        .Select(rm => (rm.Nome ?? "") + (rm.Tamanho ?? ""))
    );

    int linhasExtras = ViewBag.LinhasAdicionais ?? 1;
}

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1>Editar Exame #@Model.ExameId</h1>
        <a asp-action="Index" class="btn btn-secondary">Voltar</a>
    </div>

    <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">Atualizar Dados e Materiais</h5>
        </div>

        <div class="card-body">
            <form asp-action="Edit" asp-route-id="@Model.ExameId" method="post" id="editForm">
                @* Campos ocultos para controlo do Post-back sem perda de dados *@
                <input type="hidden" name="actionType" id="actionType" value="Save" />
                <input type="hidden" name="novoExameTipoId" id="novoExameTipoId" value="" />
                <input type="hidden" name="adicionarLinhas" id="adicionarLinhas" value="@linhasExtras" />

                <input type="hidden" asp-for="ExameId" />
                <div asp-validation-summary="All" class="text-danger mb-3"></div>

                <div class="row">
                    <div class="col-md-5 border-end">
                        <div class="mb-3">
                            <label asp-for="UtenteId" class="fw-bold">Utente</label>
                            <select asp-for="UtenteId" class="form-control" asp-items="ViewBag.UtenteId"></select>
                        </div>

                        <div class="mb-3">
                            <label asp-for="DataHoraMarcacao" class="fw-bold">Data e Hora</label>
                            <input asp-for="DataHoraMarcacao" type="datetime-local" class="form-control" />
                        </div>

                        <div class="mb-3">
                            <label asp-for="Estado" class="fw-bold">Estado do Exame</label>
                            <select asp-for="Estado" class="form-control">
                                @foreach (var op in HealthWellBeing.Models.Exame.OpcoesEstado)
                                {
                                    <option value="@op">@op</option>
                                }
                            </select>
                        </div>

                        <div class="mb-4 bg-light p-3 border rounded shadow-sm">
                            <label asp-for="ExameTipoId" class="fw-bold text-primary">Tipo de Exame (Atualiza Receita)</label>
                            <select asp-for="ExameTipoId" class="form-control border-primary"
                                    asp-items="ViewBag.ExameTipoId"
                                    onchange="document.getElementById('actionType').value='Refresh'; document.getElementById('novoExameTipoId').value=this.value; this.form.submit();">
                                <option value="">-- redefinir receita --</option>
                            </select>
                            <small class="text-muted">Mudar o tipo mantém os dados preenchidos e atualiza os materiais.</small>
                        </div>

                        <div class="mb-3">
                            <label asp-for="MedicoSolicitanteId" class="fw-bold">Médico</label>
                            <select asp-for="MedicoSolicitanteId" class="form-control" asp-items="ViewBag.MedicoSolicitanteId"></select>
                        </div>

                        <div class="mb-3">
                            <label asp-for="ProfissionalExecutanteId" class="fw-bold">Profissional</label>
                            <select asp-for="ProfissionalExecutanteId" class="form-control" asp-items="ViewBag.ProfissionalExecutanteId"></select>
                        </div>

                        <div class="mb-3">
                            <label asp-for="SalaDeExameId" class="fw-bold">Sala</label>
                            <select asp-for="SalaDeExameId" class="form-control" asp-items="ViewBag.SalaDeExameId"></select>
                        </div>

                        <div class="mb-3">
                            <label asp-for="Notas" class="fw-bold">Notas</label>
                            <textarea asp-for="Notas" class="form-control" rows="3"></textarea>
                        </div>
                    </div>

                    <div class="col-md-7">
                        <h6 class="fw-bold">Materiais do Dicionário (Seleção)</h6>

                        <div class="border rounded bg-white" style="max-height:480px; overflow-y:auto;">
                            <table class="table table-sm align-middle mb-0">
                                <thead class="table-dark">
                                    <tr>
                                        <th style="width:40px;"></th>
                                        <th>Material</th>
                                        <th style="width:80px;">Qtd</th>
                                        <th>Estado</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var item in (List<HealthWellbeing.Models.MaterialEquipamentoAssociado>)ViewBag.DicionarioCompleto)
                                    {
                                        var chaveItem = (item.NomeEquipamento ?? "") + (item.Tamanho ?? "");
                                        var registro = (Model.RegistoMateriais ?? new List<HealthWellbeing.ViewModels.RegistoMateriais>())
                                        .FirstOrDefault(rm => rm.Nome == item.NomeEquipamento && rm.Tamanho == item.Tamanho);

                                        bool estaAtivo = materiaisAtivos.Contains(chaveItem);

                                        <tr>
                                            <td class="text-center">
                                                <input type="checkbox" name="selecionadosIds" value="@item.MaterialEquipamentoAssociadoId" @(estaAtivo ? "checked" : "") />
                                            </td>
                                            <td>
                                                <strong>@item.NomeEquipamento</strong><br />
                                                <small class="text-muted">@(item.Tamanho ?? "N/A")</small>
                                            </td>
                                            <td>
                                                <input type="number" name="quantidades" class="form-control form-control-sm"
                                                       value="@(estaAtivo? registro.Quantidade: 1)" min="1" />
                                            </td>
                                            <td>
                                                <select name="estadosIds" class="form-control form-control-sm">
                                                    @foreach (var estado in (ViewBag.ListaEstadosMateriais as SelectList))
                                                    {
                                                        @* CORREÇÃO: Força o ID 9 (Reservado) se for novo ou carregado da receita *@
                                                        bool sel = (estaAtivo && registro.MaterialStatusId.ToString() == estado.Value)
                                                        || (!estaAtivo && estado.Value == "9");

                                                        <option value="@estado.Value" selected="@(sel ? "selected" : null)">@estado.Text</option>
                                                    }
                                                </select>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>

                        <div class="mt-4 p-3 border rounded bg-light">
                            <h6 class="fw-bold text-success">Adicionar novos materiais ao dicionário</h6>

                            @for (int i = 0; i < linhasExtras; i++)
                            {
                                <div class="row g-2 mb-2">
                                    <input type="hidden" name="selecionadosIds" value="0" />
                                    <div class="col-5">
                                        <input type="text" name="nomesNovos" class="form-control form-control-sm" placeholder="Nome" />
                                    </div>
                                    <div class="col-3">
                                        <input type="text" name="tamanhosNovos" class="form-control form-control-sm" placeholder="Tamanho" />
                                    </div>
                                    <div class="col-2">
                                        <input type="number" name="quantidades" value="1" class="form-control form-control-sm" />
                                    </div>
                                    <div class="col-2">
                                        <select name="estadosIds" class="form-control form-control-sm">
                                            @foreach (var estado in (ViewBag.ListaEstadosMateriais as SelectList))
                                            {
                                                @* CORREÇÃO: Garante que novas linhas iniciam em Reservado (ID 9) *@
                                                <option value="@estado.Value" selected="@(estado.Value == "9" ? "selected" : null)">@estado.Text</option>
                                            }
                                        </select>
                                    </div>
                                </div>
                            }

                            <div class="text-center mt-2">
                                <button type="submit" name="actionType" value="Refresh"
                                        onclick="document.getElementById('adicionarLinhas').value = @(linhasExtras + 1);"
                                        class="btn btn-outline-success btn-sm">
                                    + Adicionar mais uma linha
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="text-end mt-4">
                    <button type="submit" name="actionType" value="Save" class="btn btn-primary btn-lg px-5 shadow">
                        Guardar Alterações
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>