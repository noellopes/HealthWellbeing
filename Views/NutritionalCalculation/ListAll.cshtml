@model List<HealthWellbeing.Models.ClientCalculationViewModel>

@{
    ViewData["Title"] = "Nutritional Calculations - All Clients";
}

<div class="container">
    <h2><i class="bi bi-calculator"></i> Nutritional Calculations</h2>
    <p class="text-muted">Calculated nutritional needs for all clients</p>

    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success">
            @TempData["SuccessMessage"]
        </div>
    }

    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5>Summary Statistics</h5>
                </div>
                <div class="card-body">
                    @{
                        var totalClients = Model.Count;
                        var avgCalories = Model.Average(item => item.Calculation?.DailyCalories ?? 0);
                        var avgProtein = Model.Average(item => item.Calculation?.DailyProtein ?? 0);
                        var avgCarbs = Model.Average(item => item.Calculation?.DailyCarbs ?? 0);
                        var avgFat = Model.Average(item => item.Calculation?.DailyFat ?? 0);
                    }

                    <div class="row text-center">
                        <div class="col-md-3">
                            <div class="stat-card">
                                <h3>@totalClients</h3>
                                <p class="text-muted">Total Clients</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card">
                                <h3>@avgCalories.ToString("0")</h3>
                                <p class="text-muted">Avg. Calories</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card">
                                <h3>@avgProtein.ToString("0")g</h3>
                                <p class="text-muted">Avg. Protein</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card">
                                <h3>@avgCarbs.ToString("0")g</h3>
                                <p class="text-muted">Avg. Carbs</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    @if (!Model.Any())
    {
        <div class="alert alert-info">
            No clients found for nutritional calculations.
        </div>
    }
    else
    {
        <div class="table-responsive">
            <table class="table table-striped table-bordered table-hover">
                <thead class="thead-dark">
                    <tr>
                        <th>Client</th>
                        <th>Age</th>
                        <th>Weight (kg)</th>
                        <th>Height (cm)</th>
                        <th>BMI</th>
                        <th>Goal</th>
                        <th>Calories</th>
                        <th>Protein (g)</th>
                        <th>Carbs (g)</th>
                        <th>Fat (g)</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model)
                    {
                        <tr>
                            <td>
                                <strong>@item.Client.Name</strong><br>
                                <small class="text-muted">@item.Client.Email</small>
                            </td>
                            <td>@item.Calculation.Age</td>
                            <td>@item.Client.WeightKg.ToString("0.0")</td>
                            <td>@item.Client.HeightCm</td>
                            <td>
                                <span class="badge @GetBMIBadgeClass(item.Calculation.BMI)">
                                    @item.Calculation.BMI.ToString("0.0")
                                </span>
                            </td>
                            <td>
                                <span class="badge @GetGoalBadgeClass(item.Calculation.GoalType)">
                                    @item.Calculation.GoalType
                                </span>
                            </td>
                            <td><strong>@item.Calculation.DailyCalories.ToString("0")</strong></td>
                            <td>@item.Calculation.DailyProtein.ToString("0")</td>
                            <td>@item.Calculation.DailyCarbs.ToString("0")</td>
                            <td>@item.Calculation.DailyFat.ToString("0")</td>
                            <td>
                                <div class="btn-group" role="group">
                                    <a asp-action="Calculate"
                                       asp-route-id="@item.Client.ClientId"
                                       class="btn btn-sm btn-info"
                                       title="View Detailed Calculation">
                                        <i class="bi bi-eye"></i>
                                    </a>
                                    <a asp-controller="Client"
                                       asp-action="Details"
                                       asp-route-id="@item.Client.ClientId"
                                       class="btn btn-sm btn-secondary"
                                       title="View Client Details">
                                        <i class="bi bi-person"></i>
                                    </a>
                                    <a asp-action="CompareWithGoal"
                                       asp-route-id="@item.Client.ClientId"
                                       class="btn btn-sm btn-warning"
                                       title="Compare with Goal">
                                        <i class="bi bi-graph-up"></i>
                                    </a>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }

    <div class="card mt-4">
        <div class="card-header">
            <h5>Legend</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <h6>BMI Categories:</h6>
                    <span class="badge bg-danger">Obesity (≥30)</span>
                    <span class="badge bg-warning">Overweight (25-29.9)</span>
                    <span class="badge bg-success">Normal (18.5-24.9)</span>
                    <span class="badge bg-info">Underweight (<18.5)</span>
                </div>
                <div class="col-md-4">
                    <h6>Goal Types:</h6>
                    <span class="badge bg-primary">Weight Loss</span>
                    <span class="badge bg-success">Muscle Gain</span>
                    <span class="badge bg-secondary">Maintenance</span>
                </div>
                <div class="col-md-4">
                    <h6>Actions:</h6>
                    <button class="btn btn-sm btn-info mb-1"><i class="bi bi-eye"></i> = View Calculation</button><br>
                    <button class="btn btn-sm btn-secondary mb-1"><i class="bi bi-person"></i> = Client Details</button><br>
                    <button class="btn btn-sm btn-warning"><i class="bi bi-graph-up"></i> = Compare with Goal</button>
                </div>
            </div>
        </div>
    </div>

    <div class="mt-4">
        <a asp-controller="Home" asp-action="Index" class="btn btn-secondary">
            <i class="bi bi-house"></i> Back to Home
        </a>
        <a asp-controller="Client" asp-action="Index" class="btn btn-primary">
            <i class="bi bi-people"></i> View All Clients
        </a>
    </div>
</div>

@functions {
    string GetBMIBadgeClass(double bmi)
    {
        if (bmi < 18.5) return "bg-info";
        if (bmi < 25) return "bg-success";
        if (bmi < 30) return "bg-warning";
        return "bg-danger";
    }

    string GetGoalBadgeClass(string goalType)
    {
        var goalLower = goalType?.ToLower() ?? "";
        if (goalLower.Contains("loss")) return "bg-primary";
        if (goalLower.Contains("gain")) return "bg-success";
        return "bg-secondary";
    }
}

<style>
    .stat-card {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        margin: 5px;
    }

        .stat-card h3 {
            margin: 0;
            color: #0d6efd;
        }

    .table th {
        background-color: #343a40;
        color: white;
    }

    .btn-group .btn {
        margin-right: 3px;
    }

    .table tbody tr:hover {
        background-color: #f5f5f5;
    }
</style>