@model RPaginationInfo<HealthWellbeingRoom.Models.RoomReservation>

@{
    ViewData["Title"] = "Reservas de Salas";

    bool isAdmin = User.IsInRole("Administrator");
    bool isLogTech = User.IsInRole("logisticsTechnician");
}

<h1 class="mb-4 text-success">
    <i class="bi bi-calendar-check me-2"></i> Lista das reservas de Salas
</h1>

@if (TempData["SuccessMessage"] != null)
{
    <div id="success-alert" class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="bi bi-check-circle-fill me-1"></i>
        @TempData["SuccessMessage"]
    </div>
}

@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger">@TempData["ErrorMessage"]</div>
}

<div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="h4">Reservas de Salas</h2>
    <div class="d-flex gap-2">
        <a class="btn btn-outline-primary btn-sm"
           style="min-width:150px"
           data-bs-toggle="collapse"
           data-bs-target="#postSearch"
           aria-expanded="false"
           aria-controls="postSearch">
            <i class="bi bi-search me-1"></i> Pesquisa
        </a>

        @if (isLogTech)
        {
            <a asp-action="Create"
               class="btn btn-success btn-sm"
               style="min-width:150px">
                <i class="bi bi-plus-circle me-1"></i> Nova Reserva
            </a>
        }
    </div>
</div>

<!-- FORMULÁRIO DE PESQUISA -->
<div class="collapse mt-2 mb-3" id="postSearch">
    <div class="card card-body">
        <form asp-action="Index" method="get" class="row g-2 align-items-end">

            <div class="col-md-4">
                <label for="searchResponsible" class="form-label">Responsável</label>
                <input id="searchResponsible"
                       name="searchResponsible"
                       value="@ViewBag.SearchResponsible"
                       class="form-control"
                       placeholder="Nome do responsável"
                       type="search" />
            </div>

            <div class="col-md-4">
                <label for="searchDate" class="form-label">Data da Reserva</label>
                <input id="searchDate"
                       name="searchDate"
                       value="@ViewBag.SearchDate"
                       class="form-control"
                       type="date" />
            </div>

            <div class="col-md-4">
                <label for="searchRoom" class="form-label">Sala</label>
                @Html.DropDownList(
                "searchRoom",
                                ViewBag.Rooms as SelectList,
                                "Todas as salas",
                                new { @class = "form-select", @id = "searchRoom" }
                                )
            </div>

            <div class="col-12 mt-2 d-flex gap-2">
                <input type="hidden" name="page" value="1" />

                <button type="submit" class="btn btn-outline-primary flex-fill">
                    <i class="bi bi-search me-1"></i> Pesquisa
                </button>

                <a asp-action="Index" class="btn btn-secondary flex-fill">
                    <i class="bi bi-x-circle me-1"></i> Limpar
                </a>
            </div>
        </form>
    </div>
</div>

<div class="card shadow-sm" style="min-height: 60vh;">
    <div class="card-body d-flex flex-column">

        <div class="table-responsive flex-grow-1">
            <table class="table h-100">
                <thead>
                    <tr>
                        <th>Id da Consulta</th>
                        <th>Responsável</th>
                        <th>Sala</th>
                        <th>Data da Reserva</th>
                        <th>Início</th>
                        <th>Fim</th>
                        <th class="text-center">Ações</th>
                    </tr>
                </thead>

                <tbody>
                    @if (!Model.Items.Any())
                    {
                        <tr>
                            <td colspan="7" class="text-center text-muted py-5">
                                Ainda não há reservas de salas.
                            </td>
                        </tr>
                    }
                    else
                    {
                        @foreach (var item in Model.Items)
                        {
                            // Lógica de materiais da sala para a cor do botão
                            bool hasDevices = item.Room?.LocalizacaoDispMedicoMovel != null
                            && item.Room.LocalizacaoDispMedicoMovel.Any();
                            bool hasConsumables = item.Room?.RoomConsumables != null
                            && item.Room.RoomConsumables.Any();
                            bool materialOk = hasDevices && hasConsumables;

                            <tr>
                                <!-- ID CONSULTA -->
                                <td>@item.ConsultationId.ToString("D3")</td>

                                <!-- RESPONSÁVEL -->
                                <td>@(string.IsNullOrWhiteSpace(item.ResponsibleName) ? "—" : item.ResponsibleName)</td>

                                <!-- SALA -->
                                <td>@(item.Room?.Name ?? "—")</td>

                                <!-- DATA DA RESERVA -->
                                <td>@item.ConsultationDate.ToString("dd/MM/yyyy")</td>

                                <!-- HORAS -->
                                <td>@item.StartHour.ToString(@"hh\:mm")</td>
                                <td>@item.EndHour.ToString(@"hh\:mm")</td>

                                <!-- AÇÕES -->
                                <td class="text-center">

                                    @if (isLogTech)
                                    {
                                        <a asp-action="Edit"
                                           asp-route-id="@item.RoomReservationId"
                                           class="btn btn-sm btn-warning me-1">
                                            <i class="bi bi-pencil-square"></i> Editar
                                        </a>
                                    }

                                    <a asp-action="Details"
                                       asp-route-id="@item.RoomReservationId"
                                       asp-route-fromCreation="false"
                                       class="btn btn-sm btn-info me-1">
                                        <i class="bi bi-info-circle-fill"></i> Detalhes
                                    </a>

                                    @if (isLogTech)
                                    {
                                        <form asp-action="CancelarReserva"
                                              asp-route-id="@item.RoomReservationId"
                                              method="post"
                                              style="display:inline;">
                                            @Html.AntiForgeryToken()
                                            <button type="submit" class="btn btn-sm btn-danger me-1">
                                                <i class="bi bi-x-circle-fill"></i> Cancelar
                                            </button>
                                        </form>
                                    }

                                    @if (isLogTech)
                                    {
                                        bool aceitaClick =
                                        item.ConsultationDate.Date == DateTime.Today &&
                                        DateTime.Now.TimeOfDay >= item.StartHour;

                                        if (aceitaClick)
                                        {
                                            <form asp-action="MarcarComoRealizada"
                                                  asp-route-id="@item.RoomReservationId"
                                                  method="post"
                                                  style="display:inline;">
                                                @Html.AntiForgeryToken()
                                                <button type="submit" class="btn btn-sm btn-primary me-1">
                                                    <i class="bi bi-check-circle-fill"></i> Realizada
                                                </button>
                                            </form>
                                        }
                                        else
                                        {
                                            <button type="button" class="btn btn-sm btn-secondary me-1" disabled>
                                                <i class="bi bi-check-circle-fill"></i> Realizada
                                            </button>
                                        }
                                    }

                                    <a asp-controller="RoomReservations"
                                       asp-action="RoomMaterials"
                                       asp-route-Id="@item.RoomId"
                                       class="btn btn-sm @(materialOk ? "btn-success" : "btn-danger")">
                                        <i class="bi bi-box-seam"></i> Material
                                    </a>

                                </td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>

    </div>
</div>

<!-- PAGINAÇÃO -->
<nav aria-label="Room reservations page" class="d-flex justify-content-between align-items-center mt-4">
    @if (Model.TotalItems > 0)
    {
        <span class="text-muted">
            Mostrando
            <strong>@((Model.CurrentPage - 1) * Model.ItemsPerPage + 1)</strong>
            -
            <strong>@(Math.Min(Model.CurrentPage * Model.ItemsPerPage, Model.TotalItems))</strong>
            de <strong>@Model.TotalItems</strong>
        </span>
    }
    else
    {
        <span class="text-muted">0 itens</span>
    }

    <ul class="pagination mb-0">
        @if (Model.CurrentPage == 1)
        {
            <li class="page-item disabled">
                <a class="page-link"><i class="bi bi-chevron-double-left"></i> Primeira</a>
            </li>
        }
        else
        {
            <li class="page-item">
                <a class="page-link"
                   asp-action="Index"
                   asp-route-page="1"
                   asp-route-searchResponsible="@ViewBag.SearchResponsible"
                   asp-route-searchDate="@ViewBag.SearchDate"
                   asp-route-searchRoom="@ViewBag.SearchRoom">
                    <i class="bi bi-chevron-double-left"></i> Primeira
                </a>
            </li>
        }

        @for (int p = Model.FirstPageShow; p <= Model.LastPageShow; p++)
        {
            if (p == Model.CurrentPage)
            {
                <li class="page-item active">
                    <a class="page-link" href="#">@p</a>
                </li>
            }
            else
            {
                <li class="page-item">
                    <a class="page-link"
                       asp-action="Index"
                       asp-route-page="@p"
                       asp-route-searchResponsible="@ViewBag.SearchResponsible"
                       asp-route-searchDate="@ViewBag.SearchDate"
                       asp-route-searchRoom="@ViewBag.SearchRoom">
                        @p
                    </a>
                </li>
            }
        }

        @if (Model.CurrentPage == Model.TotalPages)
        {
            <li class="page-item disabled">
                <a class="page-link">Última <i class="bi bi-chevron-double-right"></i></a>
            </li>
        }
        else
        {
            <li class="page-item">
                <a class="page-link"
                   asp-action="Index"
                   asp-route-page="@Model.TotalPages"
                   asp-route-searchResponsible="@ViewBag.SearchResponsible"
                   asp-route-searchDate="@ViewBag.SearchDate"
                   asp-route-searchRoom="@ViewBag.SearchRoom">
                    Última <i class="bi bi-chevron-double-right"></i>
                </a>
            </li>
        }
    </ul>
</nav>

<div class="mt-4 d-flex justify-content-between">

    <a asp-controller="Rooms"
       asp-action="Index"
       class="btn btn-primary btn-sm">
        <i class="bi bi-house-door-fill me-1"></i> Lista de Salas
    </a>

    <div class="d-flex gap-2">
        <a asp-controller="RoomReservations"
           asp-action="ConsumablesExpenses"
           class="btn btn-warning btn-sm">
            <i class="bi bi-droplet-half me-1"></i> Ver consumíveis gastos
        </a>

        <a asp-controller="RoomReservations"
           asp-action="Consultation"
           class="btn btn-success btn-sm">
            <i class="bi bi-people-fill me-1"></i> Ver Lista de Consultas
        </a>
    </div>
</div>

</div>

@section Scripts {
    <script>
        setTimeout(function () {
            var alert = document.getElementById('success-alert');
            if (alert) {
                alert.classList.remove('show');
                alert.classList.add('fade');
            }
        }, 4000);
    </script>
}
