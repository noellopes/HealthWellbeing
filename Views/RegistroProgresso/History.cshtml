@model HealthWellbeing.ViewModels.ProgressHistoryViewModel

@{
    ViewData["Title"] = "Histórico de Progresso";
    var records = Model.Records.ToList();
}

<h1>Histórico de Progresso</h1>
<h5 class="text-muted mb-4">Cliente: @Model.ClientName</h5>

<!-- Goal Information -->
@if (Model.Meta != null)
{
    <div class="alert alert-info mb-4">
        <h6><i class="bi bi-bullseye"></i> Metas Corporais</h6>
        <div class="row">
            <div class="col-md-2">
                <strong>Peso:</strong> @(Model.Meta.PesoObjetivo?.ToString("F1") ?? "-") kg
            </div>
            <div class="col-md-2">
                <strong>Gordura:</strong> @(Model.Meta.GorduraCorporalObjetivo?.ToString("F1") ?? "-") %
            </div>
            <div class="col-md-2">
                <strong>IMC:</strong> @(Model.Meta.IMCObjetivo?.ToString("F1") ?? "-")
            </div>
            <div class="col-md-2">
                <strong>Músculo:</strong> @(Model.Meta.MassaMuscularObjetivo?.ToString("F1") ?? "-") kg
            </div>
            <div class="col-md-2">
                <strong>Colesterol:</strong> @(Model.Meta.ColesterolObjetivo?.ToString("F0") ?? "-") mg/dL
            </div>
            <div class="col-md-2">
                <strong>Data Objetivo:</strong> @(Model.Meta.DataObjetivo?.ToShortDateString() ?? "-")
            </div>
        </div>
    </div>
}

<!-- Navigation Tabs -->
<ul class="nav nav-tabs mb-4" id="historyTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="table-tab" data-bs-toggle="tab" data-bs-target="#table-content" type="button" role="tab">
            <i class="bi bi-table"></i> Tabela
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="chart-tab" data-bs-toggle="tab" data-bs-target="#chart-content" type="button" role="tab">
            <i class="bi bi-graph-up"></i> Gráficos
        </button>
    </li>
</ul>

<div class="tab-content" id="historyTabContent">
    <!-- Table Tab -->
    <div class="tab-pane fade show active" id="table-content" role="tabpanel">
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>Data</th>
                        <th>Peso (kg)</th>
                        <th>Gordura (%)</th>
                        <th>Colesterol</th>
                        <th>IMC</th>
                        <th>Massa Muscular (kg)</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in records)
                    {
                        <tr>
                            <td>@item.RecordDate.ToShortDateString()</td>
                            <td>@(item.Weight?.ToString("F1") ?? "-")</td>
                            <td>@(item.BodyFatPercentage?.ToString("F1") ?? "-")</td>
                            <td>@(item.Cholesterol?.ToString("F0") ?? "-")</td>
                            <td>@(item.BMI?.ToString("F1") ?? "-")</td>
                            <td>@(item.MuscleMass?.ToString("F1") ?? "-")</td>
                            <td>
                                <a asp-action="Details" asp-route-id="@item.ProgressRecordId" class="btn btn-sm btn-info">
                                    <i class="bi bi-eye"></i>
                                </a>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>

    <!-- Charts Tab -->
    <div class="tab-pane fade" id="chart-content" role="tabpanel">
        @if (records.Count >= 2)
        {
            <div class="row">
                <div class="col-lg-6 mb-4">
                    <div class="card">
                        <div class="card-header">
                            <i class="bi bi-speedometer"></i> Peso e IMC
                        </div>
                        <div class="card-body">
                            <canvas id="weightChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6 mb-4">
                    <div class="card">
                        <div class="card-header">
                            <i class="bi bi-heart-pulse"></i> Composição Corporal
                        </div>
                        <div class="card-body">
                            <canvas id="bodyCompChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6 mb-4">
                    <div class="card">
                        <div class="card-header">
                            <i class="bi bi-activity"></i> Colesterol
                        </div>
                        <div class="card-body">
                            <canvas id="cholesterolChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6 mb-4">
                    <div class="card">
                        <div class="card-header">
                            <i class="bi bi-bar-chart"></i> Todas as Métricas (Normalizado)
                        </div>
                        <div class="card-body">
                            <canvas id="allMetricsChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        }
        else
        {
            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i> São necessários pelo menos 2 registos para visualizar os gráficos.
            </div>
        }
    </div>
</div>

@if (records.Count >= 2)
{
    <hr />
    <h4>Comparação de Progresso</h4>
    
    <div class="row mb-4">
        <!-- Weight Comparison -->
        <div class="col-md-3">
            <div class="card @(Model.WeightDiff < 0 ? "border-success" : Model.WeightDiff > 0 ? "border-warning" : "")">
                <div class="card-body text-center">
                    <h5><i class="bi bi-speedometer2"></i> Peso</h5>
                    <p class="h3 @(Model.WeightDiff < 0 ? "text-success" : Model.WeightDiff > 0 ? "text-warning" : "")">
                        @(Model.WeightDiff?.ToString("+0.0;-0.0;0") ?? "-") kg
                    </p>
                    <small class="text-muted">@Model.FirstRecord?.RecordDate.ToShortDateString() → @Model.LastRecord?.RecordDate.ToShortDateString()</small>
                    @if (Model.Meta?.PesoObjetivo != null && Model.WeightProgress.HasValue)
                    {
                        <div class="mt-2">
                            <div class="progress" style="height: 20px;">
                                <div class="progress-bar @(Model.WeightProgress >= 100 ? "bg-success" : Model.WeightProgress >= 50 ? "bg-info" : "bg-warning")" 
                                     role="progressbar" 
                                     style="width: @Math.Min(Math.Abs(Model.WeightProgress.Value), 100)%" 
                                     aria-valuenow="@Model.WeightProgress" aria-valuemin="0" aria-valuemax="100">
                                    @Model.WeightProgress.Value.ToString("F0")%
                                </div>
                            </div>
                            <small class="text-muted">Meta: @Model.Meta.PesoObjetivo.Value.ToString("F1") kg</small>
                        </div>
                    }
                </div>
            </div>
        </div>
        
        <!-- Body Fat Comparison -->
        <div class="col-md-3">
            <div class="card @(Model.BodyFatDiff < 0 ? "border-success" : Model.BodyFatDiff > 0 ? "border-warning" : "")">
                <div class="card-body text-center">
                    <h5><i class="bi bi-percent"></i> Gordura</h5>
                    <p class="h3 @(Model.BodyFatDiff < 0 ? "text-success" : Model.BodyFatDiff > 0 ? "text-warning" : "")">
                        @(Model.BodyFatDiff?.ToString("+0.0;-0.0;0") ?? "-") %
                    </p>
                    <small class="text-muted">@Model.FirstRecord?.RecordDate.ToShortDateString() → @Model.LastRecord?.RecordDate.ToShortDateString()</small>
                    @if (Model.Meta?.GorduraCorporalObjetivo != null && Model.BodyFatProgress.HasValue)
                    {
                        <div class="mt-2">
                            <div class="progress" style="height: 20px;">
                                <div class="progress-bar @(Model.BodyFatProgress >= 100 ? "bg-success" : Model.BodyFatProgress >= 50 ? "bg-info" : "bg-warning")" 
                                     role="progressbar" 
                                     style="width: @Math.Min(Math.Abs(Model.BodyFatProgress.Value), 100)%" 
                                     aria-valuenow="@Model.BodyFatProgress" aria-valuemin="0" aria-valuemax="100">
                                    @Model.BodyFatProgress.Value.ToString("F0")%
                                </div>
                            </div>
                            <small class="text-muted">Meta: @Model.Meta.GorduraCorporalObjetivo.Value.ToString("F1")%</small>
                        </div>
                    }
                </div>
            </div>
        </div>
        
        <!-- BMI Comparison -->
        <div class="col-md-3">
            <div class="card @(Model.BMIDiff < 0 ? "border-success" : Model.BMIDiff > 0 ? "border-warning" : "")">
                <div class="card-body text-center">
                    <h5><i class="bi bi-calculator"></i> IMC</h5>
                    <p class="h3 @(Model.BMIDiff < 0 ? "text-success" : Model.BMIDiff > 0 ? "text-warning" : "")">
                        @(Model.BMIDiff?.ToString("+0.0;-0.0;0") ?? "-")
                    </p>
                    <small class="text-muted">@Model.FirstRecord?.RecordDate.ToShortDateString() → @Model.LastRecord?.RecordDate.ToShortDateString()</small>
                    @if (Model.Meta?.IMCObjetivo != null && Model.BMIProgress.HasValue)
                    {
                        <div class="mt-2">
                            <div class="progress" style="height: 20px;">
                                <div class="progress-bar @(Model.BMIProgress >= 100 ? "bg-success" : Model.BMIProgress >= 50 ? "bg-info" : "bg-warning")" 
                                     role="progressbar" 
                                     style="width: @Math.Min(Math.Abs(Model.BMIProgress.Value), 100)%" 
                                     aria-valuenow="@Model.BMIProgress" aria-valuemin="0" aria-valuemax="100">
                                    @Model.BMIProgress.Value.ToString("F0")%
                                </div>
                            </div>
                            <small class="text-muted">Meta: @Model.Meta.IMCObjetivo.Value.ToString("F1")</small>
                        </div>
                    }
                </div>
            </div>
        </div>
        
        <!-- Muscle Mass Comparison -->
        <div class="col-md-3">
            <div class="card @(Model.MuscleMassDiff > 0 ? "border-success" : Model.MuscleMassDiff < 0 ? "border-warning" : "")">
                <div class="card-body text-center">
                    <h5><i class="bi bi-lightning"></i> Músculo</h5>
                    <p class="h3 @(Model.MuscleMassDiff > 0 ? "text-success" : Model.MuscleMassDiff < 0 ? "text-warning" : "")">
                        @(Model.MuscleMassDiff?.ToString("+0.0;-0.0;0") ?? "-") kg
                    </p>
                    <small class="text-muted">@Model.FirstRecord?.RecordDate.ToShortDateString() → @Model.LastRecord?.RecordDate.ToShortDateString()</small>
                    @if (Model.Meta?.MassaMuscularObjetivo != null && Model.MuscleMassProgress.HasValue)
                    {
                        <div class="mt-2">
                            <div class="progress" style="height: 20px;">
                                <div class="progress-bar @(Model.MuscleMassProgress >= 100 ? "bg-success" : Model.MuscleMassProgress >= 50 ? "bg-info" : "bg-warning")" 
                                     role="progressbar" 
                                     style="width: @Math.Min(Math.Abs(Model.MuscleMassProgress.Value), 100)%" 
                                     aria-valuenow="@Model.MuscleMassProgress" aria-valuemin="0" aria-valuemax="100">
                                    @Model.MuscleMassProgress.Value.ToString("F0")%
                                </div>
                            </div>
                            <small class="text-muted">Meta: @Model.Meta.MassaMuscularObjetivo.Value.ToString("F1") kg</small>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
}

<div class="mt-4">
    @if (User.IsInRole("Nutricionista"))
    {
        <a asp-action="Suggestions" asp-route-id="@Model.ClientId" class="btn btn-warning">
            <i class="bi bi-lightbulb"></i> Ver Sugestões
        </a>
    }
    <a asp-action="Index" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left"></i> Voltar à Lista
    </a>
    @if (User.IsInRole("Nutricionista"))
    {
        <a asp-action="Create" class="btn btn-success">
            <i class="bi bi-plus-circle"></i> Novo Registo
        </a>
    }
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        @if (records.Count >= 2)
        {
            var dates = records.Select(r => r.RecordDate.ToShortDateString()).ToArray();
            var weights = records.Select(r => r.Weight ?? 0).ToArray();
            var bmis = records.Select(r => r.BMI ?? 0).ToArray();
            var fats = records.Select(r => r.BodyFatPercentage ?? 0).ToArray();
            var muscles = records.Select(r => r.MuscleMass ?? 0).ToArray();
            var cholesterols = records.Select(r => r.Cholesterol ?? 0).ToArray();

            <text>
            const labels = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(dates));
            const weights = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(weights));
            const bmis = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(bmis));
            const fats = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(fats));
            const muscles = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(muscles));
            const cholesterols = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(cholesterols));

            // Weight & BMI Chart
            new Chart(document.getElementById('weightChart'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Peso (kg)',
                            data: weights,
                            borderColor: 'rgb(54, 162, 235)',
                            backgroundColor: 'rgba(54, 162, 235, 0.1)',
                            tension: 0.3,
                            fill: true,
                            yAxisID: 'y'
                        },
                        {
                            label: 'IMC',
                            data: bmis,
                            borderColor: 'rgb(255, 159, 64)',
                            backgroundColor: 'rgba(255, 159, 64, 0.1)',
                            tension: 0.3,
                            fill: false,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    interaction: { mode: 'index', intersect: false },
                    scales: {
                        y: { type: 'linear', display: true, position: 'left', title: { display: true, text: 'Peso (kg)' } },
                        y1: { type: 'linear', display: true, position: 'right', grid: { drawOnChartArea: false }, title: { display: true, text: 'IMC' } }
                    }
                }
            });

            // Body Composition Chart
            new Chart(document.getElementById('bodyCompChart'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Gordura Corporal (%)',
                            data: fats,
                            borderColor: 'rgb(255, 99, 132)',
                            backgroundColor: 'rgba(255, 99, 132, 0.1)',
                            tension: 0.3,
                            fill: true
                        },
                        {
                            label: 'Massa Muscular (kg)',
                            data: muscles,
                            borderColor: 'rgb(75, 192, 192)',
                            backgroundColor: 'rgba(75, 192, 192, 0.1)',
                            tension: 0.3,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    interaction: { mode: 'index', intersect: false }
                }
            });

            // Cholesterol Chart
            new Chart(document.getElementById('cholesterolChart'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Colesterol (mg/dL)',
                        data: cholesterols,
                        borderColor: 'rgb(153, 102, 255)',
                        backgroundColor: 'rgba(153, 102, 255, 0.2)',
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        annotation: {
                            annotations: {
                                line1: { type: 'line', yMin: 200, yMax: 200, borderColor: 'rgba(255, 99, 132, 0.5)', borderDash: [5, 5], label: { content: 'Limite' } }
                            }
                        }
                    }
                }
            });

            // Normalized Chart
            function normalize(arr) {
                const min = Math.min(...arr);
                const max = Math.max(...arr);
                if (max === min) return arr.map(() => 50);
                return arr.map(v => ((v - min) / (max - min)) * 100);
            }

            new Chart(document.getElementById('allMetricsChart'), {
                type: 'radar',
                data: {
                    labels: ['Peso', 'IMC', 'Gordura', 'Músculo', 'Colesterol'],
                    datasets: [
                        {
                            label: 'Primeiro Registo',
                            data: [weights[0], bmis[0], fats[0], muscles[0], cholesterols[0]].map((v, i) => {
                                const arr = [weights, bmis, fats, muscles, cholesterols][i];
                                const min = Math.min(...arr);
                                const max = Math.max(...arr);
                                return max === min ? 50 : ((v - min) / (max - min)) * 100;
                            }),
                            borderColor: 'rgba(255, 99, 132, 1)',
                            backgroundColor: 'rgba(255, 99, 132, 0.2)'
                        },
                        {
                            label: 'Último Registo',
                            data: [weights[weights.length-1], bmis[bmis.length-1], fats[fats.length-1], muscles[muscles.length-1], cholesterols[cholesterols.length-1]].map((v, i) => {
                                const arr = [weights, bmis, fats, muscles, cholesterols][i];
                                const min = Math.min(...arr);
                                const max = Math.max(...arr);
                                return max === min ? 50 : ((v - min) / (max - min)) * 100;
                            }),
                            borderColor: 'rgba(54, 162, 235, 1)',
                            backgroundColor: 'rgba(54, 162, 235, 0.2)'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        r: { beginAtZero: true, max: 100 }
                    }
                }
            });
            </text>
        }
    </script>
}
