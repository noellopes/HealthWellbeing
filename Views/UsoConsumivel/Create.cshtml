@model List<HealthWellbeing.Models.UsoConsumivel>

@{
    ViewData["Title"] = "Adicionar Consumos";
}

<h2>Adicionar Consumo(s)</h2>

@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        @TempData["ErrorMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        @TempData["SuccessMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}
<form asp-action="CreateMultiple" method="post">
    <input type="hidden" name="treatmentRecordId" value="@ViewBag.TreatmentRecordId" />

    <table class="table table-bordered">
        <thead>
            <tr>
                <th>Consumível</th>
                <th>Quantidade</th>
                <th>Data</th>
                <th>Zona de Retirada (Obrigatório)</th>
                <th></th>
            </tr>
        </thead>
        <tbody id="rows">
            <tr>
                <td>
                    <select name="ConsumivelID" class="form-control consumivel-select" required onchange="updateZona(this)">
                        <option value="">-- Selecione --</option>
                        @foreach (var item in (SelectList)ViewData["ConsumivelID"])
                        {
                            <option value="@item.Value">@item.Text</option>
                        }
                    </select>
                </td>
                <td>
                    <input name="QuantidadeUsada" type="number" min="1" class="form-control" required placeholder="Qtd" />
                </td>
                <td>
                    <input name="DataConsumo" type="date" class="form-control" required value="@DateTime.Now.ToString("yyyy-MM-dd")" />
                </td>
                <td>
                    <select name="ZonaArmazenamentoID" class="form-control zona-select" required>
                        <option value="">Selecione Consumível primeiro</option>
                    </select>
                </td>
                <td>
                    <button type="button" class="btn btn-danger btn-sm" onclick="removeRow(this)">X</button>
                </td>
            </tr>
        </tbody>
    </table>

    <div class="mt-3">
        <button type="button" class="btn btn-secondary" onclick="addRow()">+ Adicionar Linha</button>
        <button type="submit" class="btn btn-success">Guardar Tudo</button>
    </div>
</form>

<script>
    // Ler o JSON das zonas enviado pelo Controller
    const zonas = @Html.Raw(ViewBag.Zonas);

    function updateZona(selectElement) {
        const row = selectElement.closest("tr");
        const zonaSelect = row.querySelector(".zona-select");
        const qtdInput = row.querySelector("input[name='QuantidadeUsada']");
        const consumivelId = parseInt(selectElement.value);

        // Limpa opções antigas
        zonaSelect.innerHTML = "";
        qtdInput.removeAttribute("max");

        if (!consumivelId) {
             let opt = document.createElement("option");
             opt.text = "Selecione Consumível primeiro";
             zonaSelect.add(opt);
             return;
        }

        // Filtra as zonas que têm este consumível
        const zonasFiltradas = zonas.filter(z => z.ConsumivelId === consumivelId);

        if (zonasFiltradas.length === 0) {
            let opt = document.createElement("option");
            opt.text = "Sem Stock / Indisponível";
            zonaSelect.add(opt);
        } else {
            zonasFiltradas.forEach(z => {
                let opt = document.createElement("option");
                opt.value = z.ZonaId;
                // Mostra ao user quanto stock existe naquela gaveta
                opt.text = `${z.NomeZona} (Disp: ${z.QuantidadeAtual})`;
                opt.setAttribute("data-stock", z.QuantidadeAtual);
                zonaSelect.add(opt);
            });

            // Seleciona a primeira automaticamente e define o limite
            zonaSelect.selectedIndex = 0;
            atualizarLimiteMaximo(zonaSelect);
        }

        // Se mudar a zona manualmente, atualiza o limite de quantidade
        zonaSelect.onchange = function() { atualizarLimiteMaximo(this); };
    }

    function atualizarLimiteMaximo(zonaSelect) {
        const row = zonaSelect.closest("tr");
        const qtdInput = row.querySelector("input[name='QuantidadeUsada']");

        const option = zonaSelect.options[zonaSelect.selectedIndex];
        const stock = option.getAttribute("data-stock");

        if (stock) {
            qtdInput.max = stock;
            qtdInput.placeholder = `Máx: ${stock}`;
            // Se o user já escreveu mais do que o permitido, corrige
            if (parseInt(qtdInput.value) > parseInt(stock)) {
                qtdInput.value = stock;
            }
        }
    }

    function addRow() {
        const tableBody = document.getElementById("rows");
        const firstRow = tableBody.querySelector("tr");
        const newRow = firstRow.cloneNode(true);

        // Limpa valores da nova linha
        newRow.querySelector(".consumivel-select").value = "";
        newRow.querySelector("input[name='QuantidadeUsada']").value = "";
        newRow.querySelector("input[name='QuantidadeUsada']").removeAttribute("max");
        newRow.querySelector("input[name='QuantidadeUsada']").placeholder = "Qtd";

        const zonaSelect = newRow.querySelector(".zona-select");
        zonaSelect.innerHTML = '<option value="">Selecione Consumível primeiro</option>';
        zonaSelect.onchange = null; 

        tableBody.appendChild(newRow);
    }

    function removeRow(btn) {
        const rows = document.querySelectorAll("#rows tr");
        if(rows.length > 1) {
            btn.closest("tr").remove();
        } else {
            alert("É necessário pelo menos um registo.");
        }
    }
</script>